# Waarheid Marketing - Authentication & Profile System Analysis

## Overview
This codebase has a client-facing authentication system with two distinct user roles: **Client** and **Admin**. The system uses localStorage for session management and demo data storage.

---

## 1. LOGIN SYSTEMS

### Client Login System
**File: `/home/user/waarheid/signin.html`**
- Redirect: signin.html and signup.html
- Form fields: Email, Password, Remember Me checkbox
- Demo credentials available (email/password validation through DataManager)

**File: `/home/user/waarheid/js/auth.js`**
```javascript
// Client sign in form handler (lines 10-61)
const signinForm = document.getElementById('signin-form');
signinForm.addEventListener('submit', function(e) {
  const email = this.querySelector('#email').value;
  const password = this.querySelector('#password').value;
  const remember = this.querySelector('input[name="remember"]').checked;
  
  // Demo: accepts any email/password
  localStorage.setItem('authToken', 'demo_token_' + Date.now());
  localStorage.setItem('userEmail', email);
  localStorage.setItem('userRole', 'client');
  window.location.href = 'dashboard.html';
});
```

### Admin Login System
**File: `/home/user/waarheid/admin-login.html`**
- Hard-coded credentials: admin@waarheid.nl / admin123
- Pre-filled demo credentials shown to user
- Sets role as 'admin' in localStorage

**Inline script in admin-login.html (lines 75-115):**
```javascript
document.getElementById('admin-login-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const email = document.getElementById('admin-email').value;
  const password = document.getElementById('admin-password').value;
  
  if (email === 'admin@waarheid.nl' && password === 'admin123') {
    localStorage.setItem('authToken', 'admin_token_' + Date.now());
    localStorage.setItem('userEmail', email);
    localStorage.setItem('userRole', 'admin');
    localStorage.setItem('userData', JSON.stringify({
      firstName: 'Admin',
      lastName: 'User',
      email: email,
      role: 'admin'
    }));
    window.location.href = 'admin-dashboard.html';
  }
});
```

### Modal Authentication (Header)
**File: `/home/user/waarheid/js/auth-state.js` (lines 112-285)**
- Opens auth modal on "Account" button click
- Contains both sign-in and sign-up forms in tabbed interface
- Uses DataManager for credential validation

---

## 2. USER DATA STORAGE - localStorage KEYS

### Primary User Session Keys
| Key | Description | Value Example |
|-----|-------------|----------------|
| `authToken` | Authentication token | `"demo_token_1731961234567"` |
| `userEmail` | User email address | `"john@example.com"` |
| `userRole` | User role (client/admin) | `"client"` or `"admin"` |
| `userData` | Complete user profile JSON | See structure below |

### User Data Structure (JSON)
**File: `/home/user/waarheid/js/auth-state.js` (lines 350-357)**
```javascript
localStorage.setItem('userData', JSON.stringify({
  clientId: client.id,           // "client_timestamp_random"
  firstName: client.firstName,   // "John"
  lastName: client.lastName,     // "Smith"
  email: client.email,           // "john@example.com"
  company: client.company,       // "Tech Solutions Inc"
  createdAt: date.toISOString()  // "2024-01-15T00:00:00.000Z"
}));
```

### Database Storage Keys (DataManager)
```javascript
localStorage.setItem('waarheid_clients', JSON.stringify(clientsArray));
localStorage.setItem('waarheid_projects', JSON.stringify(projectsArray));
localStorage.setItem('waarheid_consultations', JSON.stringify(consultArray));
localStorage.setItem('waarheid_messages', JSON.stringify(messagesArray));
localStorage.setItem('waarheid_invoices', JSON.stringify(invoicesArray));
localStorage.setItem('waarheid_analytics', JSON.stringify(analyticsObj));
localStorage.setItem('waarheid_tickets', JSON.stringify(ticketsArray));
localStorage.setItem('waarheid_db_initialized', 'true');
```

---

## 3. USER DROPDOWN MENU LOCATIONS

### Header Dropdown (Global Navigation)
**File: `/home/user/waarheid/css/style.css` (lines 492-593)**
- Location: Top-right of header (when logged in)
- Classes: `.user-menu-header`, `.user-menu-toggle-header`, `.user-dropdown-header`
- Initialized in: `/home/user/waarheid/js/auth-state.js` (lines 44-109)

**HTML Structure (auto-generated by auth-state.js, lines 67-91):**
```html
<div class="user-menu-header">
  <button class="user-menu-toggle-header">
    <div class="user-avatar-header">
      <i class="fas fa-crown"></i>  <!-- Admin icon -->
      <i class="fas fa-user"></i>   <!-- Client icon -->
    </div>
    <span class="user-name-header">John</span>
    <i class="fas fa-chevron-down"></i>
  </button>
  
  <div class="user-dropdown-header">
    <a href="admin-dashboard.html"><i class="fas fa-chart-line"></i> Admin Dashboard</a>
    <a href="dashboard.html"><i class="fas fa-th-large"></i> My Dashboard</a>
    <div class="dropdown-divider"></div>
    <a href="#"><i class="fas fa-user-circle"></i> My Profile</a>      <!-- NOT IMPLEMENTED -->
    <a href="#"><i class="fas fa-cog"></i> Settings</a>                <!-- NOT IMPLEMENTED -->
    <div class="dropdown-divider"></div>
    <a href="#" class="logout-btn-header"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
  </div>
</div>
```

**Event Listeners (auth-state.js, lines 437-463):**
```javascript
attachUserMenuListeners: function() {
  const userMenuToggle = document.querySelector('.user-menu-toggle-header');
  const userMenu = document.querySelector('.user-menu-header');
  const logoutBtn = document.querySelector('.logout-btn-header');
  
  if (userMenuToggle && userMenu) {
    userMenuToggle.addEventListener('click', function(e) {
      e.stopPropagation();
      userMenu.classList.toggle('active');
    });
    
    document.addEventListener('click', function(e) {
      if (!userMenu.contains(e.target)) {
        userMenu.classList.remove('active');
      }
    });
  }
  
  if (logoutBtn) {
    logoutBtn.addEventListener('click', function(e) {
      e.preventDefault();
      WaarheidAuth.logout();  // Clears localStorage
    });
  }
}
```

### Dashboard Dropdown (Logged-In Page)
**File: `/home/user/waarheid/dashboard.html` (lines 28-44)**
- Location: Header of dashboard.html
- Classes: `.user-menu`, `.user-menu-toggle`, `.user-dropdown`
- Similar structure to header dropdown

**Event Listeners (dashboard.js, lines 556-583):**
```javascript
const userMenuToggle = document.querySelector('.user-menu-toggle');
const userMenu = document.querySelector('.user-menu');

if (userMenuToggle) {
  userMenuToggle.addEventListener('click', function(e) {
    e.stopPropagation();
    userMenu.classList.toggle('active');
  });
  
  document.addEventListener('click', function(e) {
    if (!userMenu.contains(e.target)) {
      userMenu.classList.remove('active');
    }
  });
}

// Logout
const logoutBtn = document.querySelector('.logout-btn');
if (logoutBtn) {
  logoutBtn.addEventListener('click', function(e) {
    e.preventDefault();
    localStorage.removeItem('authToken');
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userData');
    localStorage.removeItem('userRole');
    window.location.href = 'index.html';
  });
}
```

### Admin Dashboard Dropdown
**File: `/home/user/waarheid/admin-dashboard.html` (lines 30-45)**
- Similar to client dashboard
- Shows admin icon (crown) instead of user icon
- Event listeners in admin.js (lines 3825-3852)

---

## 4. CURRENT USER PROFILE INFORMATION AVAILABLE

From `userData` in localStorage:
- firstName
- lastName
- email
- company
- clientId
- createdAt

From Client records in DataManager:
```javascript
// database-init.js, lines 80-112
{
  id: 'client_demo_001',
  firstName: 'John',
  lastName: 'Smith',
  email: 'john@example.com',
  password: 'password123',
  company: 'Tech Solutions Inc',
  phone: '+31 6 1234 5678',
  createdAt: '2024-01-15T00:00:00.000Z',
  status: 'active'
}
```

### Available Demo Clients
1. john@example.com / password123
2. sarah@example.com / password123
3. mike@example.com / password123

---

## 5. SETTINGS & PROFILE PAGES

**Current Status: NOT IMPLEMENTED**

### Placeholder Links
- "My Profile" link points to `#` (no handler)
- "Settings" link points to `#` (no handler)

**Files to implement in:**
- Create: `/home/user/waarheid/profile.html`
- Create: `/home/user/waarheid/settings.html`
- Add routes to: `/home/user/waarheid/js/auth-state.js` (lines 85-86)
- Add routes to: `/home/user/waarheid/dashboard.html` (lines 38-39)
- Add routes to: `/home/user/waarheid/admin-dashboard.html` (lines 41)

---

## 6. AUTHENTICATION/SESSION MANAGEMENT

### Authentication Check Functions
**File: `/home/user/waarheid/js/auth-state.js` (lines 12-42)**
```javascript
window.WaarheidAuth = {
  isLoggedIn: function() {
    return !!localStorage.getItem('authToken');
  },
  
  isAdmin: function() {
    const userRole = localStorage.getItem('userRole');
    return userRole === 'admin';
  },
  
  getCurrentUser: function() {
    const userData = localStorage.getItem('userData');
    return userData ? JSON.parse(userData) : null;
  },
  
  getUserEmail: function() {
    return localStorage.getItem('userEmail') || '';
  },
  
  logout: function() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userData');
    localStorage.removeItem('userRole');
    window.location.href = 'index.html';
  }
};
```

### Role-Based Access Control
**Client Dashboard (dashboard.js, lines 8-22):**
```javascript
const authToken = localStorage.getItem('authToken');
const userRole = localStorage.getItem('userRole');

if (!authToken) {
  window.location.href = 'index.html';
  return;
}

// Redirect admin to admin dashboard
if (userRole === 'admin') {
  window.location.href = 'admin-dashboard.html';
  return;
}
```

**Admin Dashboard (admin.js, lines 8-16):**
```javascript
const authToken = localStorage.getItem('authToken');
const userRole = localStorage.getItem('userRole');

if (!authToken || userRole !== 'admin') {
  window.location.href = 'admin-login.html';
  return;
}
```

### Header Initialization
**File: `/home/user/waarheid/js/auth-state.js` (lines 44-109)**
- Checks if user is logged in
- Renders appropriate menu based on role
- Shows "Admin Dashboard" for admins, "My Dashboard" for clients
- Displays user's first name in the header

---

## 7. ADMIN DASHBOARD HTML & JS

### HTML File
**Path: `/home/user/waarheid/admin-dashboard.html`**
- Lines: 1-107
- Key sections:
  - Dashboard header with admin badge (line 21)
  - Sidebar navigation (lines 52-91)
  - Main content area (lines 93-96)
  - Modal container (line 100)

**Sidebar Sections:**
- Overview
- Consultations
- Time Slots
- Projects
- Clients
- Messages
- Invoices
- Analytics

### JavaScript File
**Path: `/home/user/waarheid/js/admin.js`**
- Size: 3,937 lines
- Key functions:
  - `loadSection(section)` - Dynamically loads content
  - `navigateToSection(section)` - Navigation handler
  - `updateConsultationsBadge()` - Badge updates
  - `updateMessagesBadge()` - Badge updates
  - User menu initialization (lines 3825-3852)
  - Logout functionality

**Authentication (lines 6-16):**
```javascript
const authToken = localStorage.getItem('authToken');
const userRole = localStorage.getItem('userRole');

if (!authToken || userRole !== 'admin') {
  window.location.href = 'admin-login.html';
  return;
}
```

---

## 8. CLIENT DASHBOARD HTML & JS

### HTML File
**Path: `/home/user/waarheid/dashboard.html`**
- Lines: 1-467
- Structure:
  - Dashboard header (lines 15-47)
  - Sidebar navigation (lines 52-92)
  - Main content with multiple sections (lines 95-441)
  - Project detail modal (lines 447-458)

**Navigation Sections:**
- Dashboard (Overview)
- My Projects
- Analytics
- Reports
- Messages
- Schedule
- Invoices

### JavaScript File
**Path: `/home/user/waarheid/js/dashboard.js`**
- Size: 2,618 lines
- Key functions:
  - `loadClientDashboard()` - Loads user data
  - `loadSectionContent(sectionName)` - Dynamic section loading
  - `openProjectDetail(id)` - Modal handling
  - `navigateToSection(sectionName)` - Navigation

**User Data Loading (lines 24-99):**
```javascript
const userData = JSON.parse(localStorage.getItem('userData') || '{}');
const clientId = userData.clientId;

function loadClientDashboard() {
  const firstName = userData.firstName || 'User';
  
  // Update user name displays
  document.querySelectorAll('.user-name-display').forEach(el => {
    el.textContent = firstName;
  });
  
  document.querySelectorAll('.user-name').forEach(el => {
    el.textContent = userData.firstName && userData.lastName
      ? `${userData.firstName} ${userData.lastName}`
      : userData.email || 'User';
  });
}
```

---

## 9. DATA MANAGER STRUCTURE

**File: `/home/user/waarheid/js/data-manager.js`**

### Managers Available
```javascript
return {
  clients: ClientManager,
  projects: ProjectManager,
  consultations: ConsultationManager,
  messages: MessageManager,
  invoices: InvoiceManager,
  analytics: AnalyticsManager,
  tickets: TicketManager,
  timeslots: TimeSlotManager,
  notifications: NotificationManager,
  generateId(prefix),
  clearAll()
};
```

### Client Manager Methods
- `getAll()` - Get all clients
- `getById(clientId)` - Get client by ID
- `getByEmail(email)` - Get client by email
- `create(clientData)` - Create new client
- `update(clientId, updates)` - Update client
- `delete(clientId)` - Delete client

---

## 10. AUTHENTICATION FLOW DIAGRAM

```
User on Public Site
        |
        v
    Click "Account" Button in Header
        |
        v
    WaarheidAuth.openAuthModal() (auth-state.js:112)
        |
        +---> Sign In Tab
        |      |
        |      v
        |   Enter Email/Password
        |      |
        |      v
        |   DataManager.clients.getByEmail(email)
        |      |
        |      v
        |   Validate password
        |      |
        |      v
        |   localStorage.setItem('authToken', token)
        |   localStorage.setItem('userData', JSON.stringify(userData))
        |   localStorage.setItem('userRole', 'client')
        |      |
        |      v
        |   Redirect to dashboard.html
        |
        +---> Sign Up Tab
               |
               v
            Enter Name, Email, Password
               |
               v
            DataManager.clients.create(userData)
               |
               v
            localStorage.setItem(...same as sign in...)
               |
               v
            Redirect to dashboard.html

OR

Admin Login
        |
        v
    Navigate to admin-login.html
        |
        v
    Enter admin@waarheid.nl / admin123
        |
        v
    localStorage.setItem('userRole', 'admin')
        |
        v
    Redirect to admin-dashboard.html
        |
        v
    Dashboard.js checks role and redirects client to dashboard.html
    Admin.js checks role and allows access
```

---

## 11. IMPLEMENTATION RECOMMENDATIONS

### For Profile/Settings System
1. **Create profile.html** - Edit user profile information
2. **Create settings.html** - Preferences, notifications, security
3. **Extend userData structure** with:
   - Phone number
   - Address/Location
   - Preferences object
   - Two-factor authentication setting
   - Notification preferences

4. **Add to auth-state.js:**
```javascript
// Update links in dropdown
<a href="profile.html"><i class="fas fa-user-circle"></i> My Profile</a>
<a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
```

### Role-Based Access Control Implementation
1. **Extend isAdmin()** to check specific permissions
2. **Add permission levels:**
   - admin: full access
   - client: dashboard + own projects
   - super_admin: everything

3. **Protect routes in all JS files** with role checks

### Security Improvements Needed
1. Replace demo credentials with real authentication
2. Hash passwords before storing
3. Implement real token system (JWT)
4. Remove hardcoded credentials from HTML
5. Move authentication to backend API

---

## Summary Table

| Component | File | Lines | Status |
|-----------|------|-------|--------|
| Client Login | signin.html | 1-113 | Implemented |
| Client Signup | signup.html | 1-147 | Implemented |
| Admin Login | admin-login.html | 1-118 | Implemented |
| Auth State Manager | js/auth-state.js | 1-478 | Implemented |
| Auth Form Handling | js/auth.js | 1-383 | Implemented |
| Client Dashboard | dashboard.html | 1-467 | Implemented |
| Admin Dashboard | admin-dashboard.html | 1-107 | Implemented |
| Client Dashboard JS | js/dashboard.js | 1-2618 | Implemented |
| Admin Dashboard JS | js/admin.js | 1-3937 | Implemented |
| Data Manager | js/data-manager.js | Multiple | Implemented |
| Database Init | js/database-init.js | 1-639 | Implemented |
| Profile Page | N/A | N/A | NOT IMPLEMENTED |
| Settings Page | N/A | N/A | NOT IMPLEMENTED |

